#!/usr/bin/env bash

if [ "$1" == "upgrade" ]; then
  (
    cd $OPENCODE_PATH
    git pull origin dev
    git pull upstream dev
    bun install
    sed -i 's/if (!semver.satisfies.*$/if (false) {/' packages/script/src/index.ts
    env OPENCODE_VERSION="$(jq -r '.version' packages/opencode/package.json)-custom" bun run packages/opencode/script/build.ts --single --skip-install
    git checkout packages/script/src/index.ts
  )
else
  eval "$OPENCODE_PATH/packages/opencode/dist/opencode-*/bin/opencode $@" || echo "opencode not found at OPENCODE_PATH: $OPENCODE_PATH"
fi
